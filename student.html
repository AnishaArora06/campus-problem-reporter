<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Report Problem - Campus Problem Reporter</title>
  <link rel="stylesheet" href="css/style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
</head>

<body>
  <!-- Navigation -->
  <nav class="navbar">
    <div class="nav-container">
      <div class="nav-logo">
        <h2>Campus Problem Reporter</h2>
      </div>
      <ul class="nav-menu">
        <li><a href="index.html" class="nav-link">Home</a></li>
        <li><a href="student.html" class="nav-link active">Report Problem</a></li>
        <li><a href="admin.html" class="nav-link">Admin Dashboard</a></li>
        <li><a href="index.html#team" class="nav-link">Team</a></li>
        <li><a href="index.html#contact" class="nav-link">Contact</a></li>
        <li><button id="theme-toggle" class="theme-toggle"><i class="fas fa-moon"></i></button></li>
      </ul>
      <div class="hamburger"><span></span><span></span><span></span></div>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="main-content">
    <div class="container">
      <div class="page-header">
        <h1>Report a Problem</h1>
        <p>Help us improve campus facilities by reporting issues you encounter</p>
      </div>

      <div class="form-container">
        <form class="problem-form" id="problemForm" enctype="multipart/form-data" method="POST">
          <div class="form-row">
            <div class="form-group">
              <input type="text" id="studentName" name="studentName" required />
              <label for="studentName">Full Name</label>
              <i class="fas fa-user form-icon"></i>
            </div>
            <div class="form-group">
              <input type="text" id="rollNumber" name="rollNumber" required />
              <label for="rollNumber">Roll Number</label>
              <i class="fas fa-id-card form-icon"></i>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <select id="department" name="department" required>
                <option value="">Select Department</option>
                <option value="Computer Science">Computer Science</option>
                <option value="Electronics">Electronics</option>
                <option value="Mechanical">Mechanical</option>
                <option value="Civil">Civil</option>
                <option value="Electrical">Electrical</option>
                <option value="Chemical">Chemical</option>
                <option value="Biotechnology">Biotechnology</option>
                <option value="MBA">MBA</option>
                <option value="Other">Other</option>
              </select>
              <label for="department">Department</label>
              <i class="fas fa-graduation-cap form-icon"></i>
            </div>
            <div class="form-group">
              <select id="category" name="category" required>
                <option value="">Select Category</option>
                <option value="Furniture">Furniture</option>
                <option value="Infrastructure">Infrastructure</option>
                <option value="Electronics">Electronics</option>
                <option value="Cleanliness">Cleanliness</option>
                <option value="Security">Security</option>
                <option value="Others">Others</option>
              </select>
              <label for="category">Problem Category</label>
              <i class="fas fa-tags form-icon"></i>
            </div>
          </div>

          <div class="form-group">
            <input type="text" id="location" name="location" required />
            <label for="location">Location (e.g., Library, Classroom 204, Canteen)</label>
            <i class="fas fa-map-marker-alt form-icon"></i>
          </div>

          <div class="form-group">
            <textarea id="problemDescription" name="problemDescription" required rows="5"></textarea>
            <label for="problemDescription">Problem Description</label>
            <i class="fas fa-comment-alt form-icon"></i>
          </div>

          <div class="form-group">
            <select id="priority" name="priority" required>
              <option value="">Select Priority</option>
              <option value="Low">Low - Can wait</option>
              <option value="Medium">Medium - Should be addressed soon</option>
              <option value="High">High - Needs immediate attention</option>
              <option value="Critical">Critical - Emergency</option>
            </select>
            <label for="priority">Priority Level</label>
            <i class="fas fa-exclamation-triangle form-icon"></i>
          </div>

          <!-- File Upload -->
  <div class="form-group file-upload-group" id="uploadBox">
  <!-- Hidden file input -->
  <input
    type="file"
    id="images"
    name="images"
    accept="image/png, image/jpeg, image/jpg"
    multiple
  />

  <!-- Clickable upload label -->
  <label for="images" class="file-upload-label">
    <i class="fas fa-camera"></i>
    <span>Upload Images (Optional)</span>
    <small>You can upload multiple images</small>
  </label>

  <!-- Preview area -->
  <div class="file-preview" id="filePreview"></div>
</div>



          <div class="form-actions">
            <button type="reset" class="btn btn-secondary">
              <i class="fas fa-undo"></i> Reset Form
            </button>
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-paper-plane"></i> Submit Report
            </button>
          </div>
        </form>
      </div>

      <!-- Success Modal -->
      <div class="modal" id="successModal">
        <div class="modal-content">
          <div class="modal-header">
            <div class="success-icon"><i class="fas fa-check-circle"></i></div>
            <h2>Report Submitted Successfully!</h2>
          </div>
          <div class="modal-body">
            <p>Thank you for reporting this issue. Your report has been received and will be reviewed by our team.</p>
            <div class="report-details">
              <p><strong>Report ID:</strong> <span id="reportId"></span></p>
              <p><strong>Status:</strong> <span class="status-badge status-pending">Pending Review</span></p>
            </div>
          </div>
          <div class="modal-actions">
            <button class="btn btn-primary" onclick="closeModal()">
              <i class="fas fa-check"></i> Got it
            </button>
            <button class="btn btn-secondary" onclick="submitAnother()">
              <i class="fas fa-plus"></i> Submit Another
            </button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer class="footer">
    <div class="container">
      <p>&copy; 2024 Campus Problem Reporter. All rights reserved.</p>
    </div>
  </footer>

  <a href="#problemForm" class="fab-button" title="Go to Form"><i class="fas fa-edit"></i></a>

  <!-- ==================== Scripts ==================== -->
  <script>
document.addEventListener("DOMContentLoaded", () => {
  const uploadLabel = document.querySelector(".file-upload-label");
  const fileInput = document.getElementById("images");
  const preview = document.getElementById("filePreview");
  const uploadGroup = document.querySelector(".file-upload-group");

  // === 1️⃣ Ensure Upload Box Is Clickable ===
  uploadLabel.addEventListener("click", (e) => {
    e.preventDefault();
    fileInput.click();
  });

  // === 2️⃣ File Input Change Event (Preview + Validation) ===
  fileInput.addEventListener("change", handleFiles);

  function handleFiles(e) {
    const files = e.target.files;
    preview.innerHTML = "";
    for (const file of files) {
      if (!file.type.startsWith("image/")) {
        alert("Only image files are allowed!");
        continue;
      }
      if (file.size > 2 * 1024 * 1024) {
        alert(`${file.name} exceeds 2MB limit`);
        continue;
      }
      const reader = new FileReader();
      reader.onload = (ev) => {
        const img = document.createElement("img");
        img.src = ev.target.result;
        img.classList.add("preview-image");
        preview.appendChild(img);
      };
      reader.readAsDataURL(file);
    }
  }

  // === 3️⃣ Drag and Drop Support ===
  uploadGroup.addEventListener("dragover", (e) => {
    e.preventDefault();
    uploadGroup.classList.add("dragging");
  });

  uploadGroup.addEventListener("dragleave", (e) => {
    e.preventDefault();
    uploadGroup.classList.remove("dragging");
  });

  uploadGroup.addEventListener("drop", (e) => {
    e.preventDefault();
    uploadGroup.classList.remove("dragging");
    const files = e.dataTransfer.files;
    fileInput.files = files; // assign dropped files
    handleFiles({ target: { files } }); // preview them
  });

  // === 4️⃣ Form Submit ===
  document.getElementById("problemForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);

    const backendURL = window.location.origin.includes("render.com")
      ? window.location.origin
      : "http://localhost:5000";

    try {
      const res = await fetch(`${backendURL}/api/problems/report`, {
        method: "POST",
        body: formData,
      });

      if (res.ok) {
        const data = await res.json();
        document.getElementById("reportId").textContent = data.reportId || "N/A";
        document.getElementById("successModal").style.display = "flex";
        e.target.reset();
        preview.innerHTML = "";
      } else {
        alert("❌ Failed to submit. Please try again.");
      }
    } catch (err) {
      console.error(err);
      alert("⚠️ Error connecting to server.");
    }
  });

  // === 5️⃣ Modal Handling ===
  window.closeModal = () => {
    document.getElementById("successModal").style.display = "none";
  };

  window.submitAnother = () => {
    document.getElementById("successModal").style.display = "none";
    document.getElementById("problemForm").scrollIntoView({ behavior: "smooth" });
  };

  // === 6️⃣ Fallback — Make the whole upload area clickable ===
  const uploadBox = document.querySelector(".file-upload-group");
  const fileInputFallback = document.getElementById("images");

  if (uploadBox && fileInputFallback) {
    uploadBox.addEventListener("click", (e) => {
      // Avoid triggering when clicking on previewed images
      if (!e.target.closest(".file-preview")) {
        fileInputFallback.click();
      }
    });
  }
});

document.addEventListener("DOMContentLoaded", () => {
  const toggleBtn = document.getElementById("theme-toggle");
  if (!toggleBtn) return;

  const icon = toggleBtn.querySelector("i");

  // 1️⃣ Load saved theme
  const savedTheme = localStorage.getItem("theme");
  if (savedTheme === "dark") {
    document.body.classList.add("dark-theme");
    icon.classList.replace("fa-moon", "fa-sun");
  }

  // 2️⃣ Toggle theme on click
  toggleBtn.addEventListener("click", () => {
    document.body.classList.toggle("dark-theme");
    const isDark = document.body.classList.contains("dark-theme");

    if (isDark) {
      icon.classList.replace("fa-moon", "fa-sun");
      localStorage.setItem("theme", "dark");
    } else {
      icon.classList.replace("fa-sun", "fa-moon");
      localStorage.setItem("theme", "light");
    }
  });
});
</script>
</body>
</html>
